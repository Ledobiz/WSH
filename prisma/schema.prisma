generator client {
  provider = "prisma-client-js"
  // output   = "generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String    @id @default(uuid()) @db.VarChar(191)
  name      String?   @db.VarChar(191)
  email     String    @unique @db.VarChar(191)
  password  String?   @db.VarChar(191)
  image     String?
  phone     String?   @db.VarChar(191)
  uid       String?   @db.VarChar(191)
  role      UserRole  @default(student)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // relationships
  carts        Cart[]
  wishlists    Wishlist[]
  transactions Transaction[]
  students     Student[]

  @@index(email)
  @@index(uid)
  @@index(createdAt)
  @@index(deletedAt)
}

enum UserRole {
  student
  admin
}

model Course {
  id                String         @id @default(uuid()) @db.VarChar(191)
  title             String         @db.VarChar(191)
  slug              String         @unique @db.VarChar(191)
  description       String?
  isActive          Boolean?       @default(true)
  category          Category       @relation(fields: [categoryId], references: [id])
  categoryId        String         @db.VarChar(191)
  originalFee       Int
  discountedFee     Int
  thumbnail         String?
  thumbnailPublicId String?
  banner            String?
  bannerPublicId    String?
  previewVideo      String?
  isFree            Boolean        @default(false)
  seoTitle          String?        @db.VarChar(191)
  seoDescription    String?
  seoKeywords       String?
  whoIsCourseFor    String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  deletedAt         DateTime?
  cartItems         CartItem[]
  wishlists         Wishlist[]
  courseModules     CourseModule[]
  students          Student[]

  @@index(slug)
  @@index(isActive)
  @@index(createdAt)
  @@index(deletedAt)
}

model CourseModule {
  id               String            @id @default(uuid()) @db.VarChar(191)
  courseId         String            @db.VarChar(191)
  course           Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  name             String            @db.VarChar(191)
  description      String?
  isActive         Boolean           @default(true)
  sorting          Int?
  totalDuration    Int?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  moduleComponents ModuleComponent[]
  studentModules   StudentModule[]

  @@index(isActive)
  @@index(sorting)
  @@index(createdAt)
  @@index(deletedAt)
}

model ModuleComponent {
  id                      String                   @id @default(uuid()) @db.VarChar(191)
  courseModuleId          String                   @db.VarChar(191)
  courseModule            CourseModule             @relation(fields: [courseModuleId], references: [id], onDelete: Cascade)
  name                    String                   @db.VarChar(191)
  description             String?
  isActive                Boolean                  @default(true)
  type                    ComponentType            @default(video)
  vimeoVideoUrl           String?
  embedVideoUrl           String?
  fileName                String?
  fileNamePublicId        String?
  isPrerequisite          Boolean                  @default(false)
  isFree                  Boolean                  @default(false)
  sorting                 Int?
  duration                Int?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  deletedAt               DateTime?
  studentModuleComponents StudentModuleComponent[]

  @@index(isActive)
  @@index(sorting)
  @@index(createdAt)
  @@index(deletedAt)
}

enum ComponentType {
  video
  file
}

model Category {
  id        String    @id @default(uuid()) @db.VarChar(191)
  name      String    @db.VarChar(191)
  slug      String    @unique @db.VarChar(191)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  courses   Course[]

  @@index(createdAt)
  @@index(deletedAt)
}

model Cart {
  id                   String       @id @default(uuid()) @db.VarChar(191)
  user                 User         @relation(fields: [userId], references: [id])
  userId               String       @db.VarChar(191)
  isPaid               Boolean?     @default(false)
  transactionReference String?      @db.VarChar(191)
  reference            Transaction? @relation(fields: [transactionReference], references: [reference])
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  cartItems            CartItem[]

  @@index(isPaid)
  @@index(createdAt)
}

model CartItem {
  id        String   @id @default(uuid()) @db.VarChar(191)
  cartId    String   @db.VarChar(191)
  cart      Cart     @relation(fields: [cartId], references: [id])
  courseId  String   @db.VarChar(191)
  course    Course   @relation(fields: [courseId], references: [id])
  couponId  String?  @db.VarChar(191)
  coupon    Coupon?  @relation(fields: [couponId], references: [id])
  price     Int
  currency  String?  @db.VarChar(3)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index(createdAt)
}

model Coupon {
  id             String     @id @default(uuid()) @db.VarChar(191)
  code           String     @db.VarChar(191)
  name           String?    @db.VarChar(191)
  description    String?
  maxUse         Int
  totalUsed      Int
  isFixedAmount  Boolean    @default(false)
  discountAmount Int
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean    @default(true)
  cartItems      CartItem[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  deletedAt      DateTime?

  @@index(code)
  @@index(endDate)
  @@index(isActive)
  @@index(createdAt)
  @@index(deletedAt)
}

model Wishlist {
  id        String   @id @default(uuid()) @db.VarChar(191)
  userId    String   @db.VarChar(191)
  user      User     @relation(fields: [userId], references: [id])
  courseId  String   @db.VarChar(191)
  course    Course   @relation(fields: [courseId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index(createdAt)
}

model Transaction {
  id               String        @id @default(uuid()) @db.VarChar(191)
  userId           String        @db.VarChar(191)
  user             User          @relation(fields: [userId], references: [id])
  reference        String        @unique @db.VarChar(191)
  carts            Cart[]
  gateway          String        @db.VarChar(191)
  name             String?       @db.VarChar(191)
  email            String?       @db.VarChar(191)
  phone            String?       @db.VarChar(191)
  currency         String        @db.VarChar(3)
  amount           Int
  first4Digits     String?       @db.VarChar(4)
  last4Digits      String?       @db.VarChar(4)
  cardBrand        String?       @db.VarChar(191)
  status           PaymentStatus @default(pending)
  confirmationSent DateTime?
  paymentSource    PaymentSource @default(website)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?

  @@index(reference)
  @@index(status)
  @@index(createdAt)
  @@index(deletedAt)
}

enum PaymentStatus {
  pending
  success
  failed
}

enum PaymentSource {
  website
  manual
  app
}

model Student {
  id                      String                   @id @default(uuid()) @db.VarChar(191)
  userId                  String                   @db.VarChar(191)
  user                    User                     @relation(fields: [userId], references: [id])
  courseId                String                   @db.VarChar(191)
  course                  Course                   @relation(fields: [courseId], references: [id])
  courseContentAssigned   Boolean                  @default(false)
  lecturesCompleted       Boolean                  @default(false)
  lastLectureId           String                   @db.VarChar(191)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  deletedAt               DateTime?
  studentModules          StudentModule[]
  studentModuleComponents StudentModuleComponent[]

  @@index(courseContentAssigned)
  @@index(lecturesCompleted)
  @@index(createdAt)
  @@index(deletedAt)
}

model StudentModule {
  id                      String                   @id @default(uuid()) @db.VarChar(191)
  studentId               String                   @db.VarChar(191)
  student                 Student                  @relation(fields: [studentId], references: [id])
  courseModuleId          String                   @db.VarChar(191)
  courseModule            CourseModule             @relation(fields: [courseModuleId], references: [id])
  name                    String                   @db.VarChar(191)
  description             String?
  isActive                Boolean                  @default(true)
  sorting                 Int?
  totalDuration           Int?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  deletedAt               DateTime?
  studentModuleComponents StudentModuleComponent[]
  studentLectureRecords   StudentLectureRecord[]

  @@index(isActive)
  @@index(sorting)
  @@index(createdAt)
  @@index(deletedAt)
}

model StudentModuleComponent {
  id                    String                 @id @default(uuid()) @db.VarChar(191)
  studentId             String                 @db.VarChar(191)
  student               Student                @relation(fields: [studentId], references: [id])
  studentModuleId       String                 @db.VarChar(191)
  studentModule         StudentModule          @relation(fields: [studentModuleId], references: [id])
  moduleComponentId     String                 @db.VarChar(191)
  moduleComponent       ModuleComponent        @relation(fields: [moduleComponentId], references: [id])
  name                  String                 @db.VarChar(191)
  description           String?
  isActive              Boolean                @default(true)
  type                  ComponentType          @default(video)
  vimeoVideoUrl         String?
  embedVideoUrl         String?
  fileName              String?
  fileNamePublicId      String?
  isPrerequisite        Boolean                @default(false)
  isFree                Boolean                @default(false)
  sorting               Int?
  duration              Int?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  deletedAt             DateTime?
  studentLectureRecords StudentLectureRecord[]

  @@index(isActive)
  @@index(sorting)
  @@index(createdAt)
  @@index(deletedAt)
}

model StudentLectureRecord {
  id                       String                 @id @default(uuid()) @db.VarChar(191)
  studentModuleId          String                 @db.VarChar(191)
  studentModule            StudentModule          @relation(fields: [studentModuleId], references: [id])
  studentModuleComponentId String                 @db.VarChar(191)
  studentModuleComponent   StudentModuleComponent @relation(fields: [studentModuleComponentId], references: [id])
  status                   LectureStatus          @default(pending)
  didYouUnderstand         Boolean                @default(false)
  suggestion               String?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  deletedAt                DateTime?

  @@index(status)
  @@index(createdAt)
  @@index(deletedAt)
}

enum LectureStatus {
  pending
  ongoing
  completed
}
